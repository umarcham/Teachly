<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/logos/learning_10051578.png">
    <link rel="icon" type="image/png" href="../assets/img/logos/learning_10051578.png">
    <title>Teachly — Code Explainer</title>

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
    <link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
    <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
    <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link id="pagestyle" href="../assets/css/material-dashboard.css?v=3.2.0" rel="stylesheet" />

    <style>
        /* Custom Overrides for Visualizer */
        body {
            overflow: hidden;
            /* Full screen app */
        }

        .main-content {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Sidebar override to match structure if needed, or use layout */
        .app-container {
            display: flex;
            height: 100vh;
        }

        .examples-sidebar {
            width: 260px;
            background: #fff;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        /* Split View Area */
        .viz-container {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            background-color: #f0f2f5;
            overflow: hidden;
        }

        .code-card {
            flex: 4;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
            /* VS Code Dark for consistency in code */
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .code-header {
            padding: 12px 20px;
            background: #252526;
            color: #ccc;
            font-size: 0.9rem;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-panel {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            color: #d4d4d4;
            font-family: 'Fira Code', monospace;
        }

        .code-line {
            display: flex;
            padding: 2px 0;
            line-height: 1.5;
        }

        .code-line.active {
            background: #37373d;
            border-left: 3px solid #007acc;
        }

        .line-num {
            width: 35px;
            color: #858585;
            text-align: right;
            padding-right: 15px;
            user-select: none;
            font-size: 0.85rem;
        }

        /* Visual Stage */
        .stage-card {
            flex: 6;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .stage-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .memory-area {
            flex: 1;
            padding: 20px;
            background: #fafafa;
            position: relative;
            display: flex;
            gap: 20px;
        }

        .mem-col {
            flex: 1;
            border: 1px dashed #ddd;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.5);
        }

        .mem-col h4 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #7b809a;
            margin-bottom: 10px;
            font-weight: 700;
        }

        /* Memory Boxes */
        .mem-box {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            width: 140px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: relative;
            transition: all 0.3s ease;
        }

        .mem-box.highlight {
            border-color: #344767;
            box-shadow: 0 0 0 3px rgba(52, 71, 103, 0.2);
        }

        .mem-box .label {
            font-weight: 600;
            font-size: 0.85rem;
            color: #344767;
            margin-bottom: 4px;
        }

        .mem-box .value {
            font-family: monospace;
            font-size: 1rem;
            color: #e91e63;
        }

        .mem-box .addr {
            position: absolute;
            top: 2px;
            right: 5px;
            font-size: 0.6rem;
            color: #adb5bd;
        }

        /* Controls */
        .control-bar {
            height: 80px;
            background: white;
            border-top: 1px solid #eee;
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .explanation-text {
            font-weight: 500;
            color: #344767;
        }

        /* Buttons */
        .btn-custom {
            white-space: nowrap;
        }
    </style>
    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- SIDEBAR -->
        <aside class="examples-sidebar">
            <div class="p-4 d-flex align-items-center">
                <img src="../assets/img/logos/learning_10051578.png" width="32" height="32" class="me-2" alt="logo">
                <span class="font-weight-bold text-dark h5 mb-0">Code Explainer</span>
            </div>
            <hr class="horizontal dark mt-0 mb-2">

            <div class="example-list px-3" id="exampleList">
                <!-- Javascript will populate this -->
                <button class="btn btn-outline-primary btn-sm w-100 mb-2"
                    onclick="document.getElementById('pasteModal').style.display='flex'">
                    + Paste Custom Code
                </button>
            </div>

            <div class="mt-auto p-3 text-center">
                <a href="/askteach" class="text-secondary text-sm font-weight-bold text-decoration-none">
                    <i class="material-symbols-rounded text-sm me-1" style="vertical-align: text-bottom;">arrow_back</i>
                    Back to Chat
                </a>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <div class="main-content flex-grow-1">
            <div
                class="navbar navbar-main bg-white border-bottom px-4 py-2 d-flex align-items-center justify-content-between">
                <h5 class="font-weight-bolder mb-0" id="progTitle">Select an example...</h5>
                <span class="badge bg-gradient-info">C Visualizer Engine</span>
            </div>

            <div class="viz-container">
                <!-- CODE CARD -->
                <div class="code-card">
                    <div class="code-header">
                        <span>SOURCE CODE</span>
                        <i class="material-symbols-rounded text-sm">code</i>
                    </div>
                    <div class="code-panel" id="codeContainer"></div>
                </div>

                <!-- STAGE CARD -->
                <div class="stage-card">
                    <div class="stage-header">
                        <span class="text-xs font-weight-bold text-secondary">MEMORY VISUALIZATION</span>
                        <div class="legend d-flex gap-3">
                            <span class="badge bg-light text-dark border"><span class="text-primary">●</span>
                                Stack</span>
                            <span class="badge bg-light text-dark border"><span class="text-danger">●</span> Heap</span>
                        </div>
                    </div>

                    <div class="memory-area">
                        <!-- MODULES -->
                        <div class="mem-col" style="flex: 0.5;">
                            <h4>Modules</h4>
                            <div id="modulesContent" class="w-100 d-flex flex-column gap-2 align-items-center"></div>
                        </div>

                        <!-- STACK -->
                        <div class="mem-col">
                            <h4 class="text-primary">Stack Memory</h4>
                            <div id="stackContent" class="w-100 d-flex flex-column gap-2 align-items-center"></div>
                        </div>

                        <!-- HEAP -->
                        <div class="mem-col" style="background:#fff5f7; border-color:#fecdd3;">
                            <h4 class="text-danger">Heap Memory</h4>
                            <div id="heapContent" class="w-100 d-flex flex-column gap-2 align-items-center"></div>
                        </div>
                    </div>

                    <!-- CONTROLS -->
                    <div class="control-bar">
                        <div id="explanationText" class="explanation-text text-sm">
                            Welcome! Select a program to start visualizing.
                        </div>
                        <div class="btn-group gap-2">
                            <button class="btn btn-secondary btn-sm mb-0" onclick="step(-1)" id="btnPrev" disabled>&lt;
                                Prev</button>
                            <button class="btn bg-gradient-primary btn-sm mb-0 btn-custom" onclick="step(1)"
                                id="btnNext" disabled>Next Line &gt;</button>
                            <button class="btn btn-outline-dark btn-sm mb-0" onclick="reset()" id="btnReset"
                                disabled>Restart</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="pasteModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100; align-items:center; justify-content:center;">
        <div
            style="background:white; padding:20px; border-radius:8px; width:500px; display:flex; flex-direction:column; gap:10px; box-shadow:0 4px 20px rgba(0,0,0,0.2);">
            <h3>Paste your C Code</h3>
            <textarea id="customCodeInput" rows="10" placeholder="#include <stdio.h>..."
                style="width:100%; font-family:monospace; padding:10px; border:1px solid #ddd; border-radius:4px;"></textarea>
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn" onclick="document.getElementById('pasteModal').style.display='none'">Cancel</button>
                <button class="btn primary" id="submitCodeBtn" onclick="submitCustomCode()">Visualize</button>
            </div>
        </div>
    </div>

    <!-- DATA INJECTION (Prevents Syntax Errors) -->
    <script type="application/json" id="data-examples">
    {{ examples | tojson | safe }}
</script>

    <script>
        // PASSED FROM BACKEND
        const codeExamples = JSON.parse(document.getElementById('data-examples').textContent);

        let currentData = null;
        let currentStepIndex = -1; // -1 = start state
        let currentMemoryState = null; // Global state for arrow renderer

        // UI Refs
        const codeContainer = document.getElementById('codeContainer');
        // ... (existing refs)

        // ...

        function updateUI() {
            // ... (setup) ...

            // --- RECOMPUTE STATE FROM SCRATCH (ROBUST) ---
            const memory = { stack: {}, modules: [], arrows: [] };

            // ... (loop logic same as before) ...

            // SAVE STATE
            currentMemoryState = memory;

            // ... (render logic same as before) ...

            // Allow DOM layout to settle before drawing arrows
            setTimeout(renderArrows, 50);
        }

        function renderArrows() {
            if (!currentMemoryState || !currentMemoryState.arrows) return;

            const container = document.querySelector('.memory-area');
            const containerRect = container.getBoundingClientRect();

            let svg = document.getElementById('arrow-layer');
            if (!svg) {
                svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.id = "arrow-layer";
                svg.style.position = 'absolute';
                svg.style.top = '0';
                svg.style.left = '0';
                svg.style.width = '100%';
                svg.style.height = '100%';
                svg.style.pointerEvents = 'none';
                svg.style.zIndex = '10';
                container.appendChild(svg);
            }
            // Reset contents
            svg.innerHTML = `
             <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                  <polygon points="0 0, 10 3.5, 0 7" fill="#6366f1" />
                </marker>
             </defs>
            `;

            // Identify boxes by text content (ID is cleaner but we used text label matching in prompt)
            // Ideally prompt sends ID. Let's assume ID is accurate.

            // Helper to get Box Coords relative to container
            const getBoxCenter = (id) => {
                // Find element by scanning stack/heap content for matching ID? 
                // We didn't set ID attribute on DOM elements! Let's assume memory.stack keys match
                // We need to add ID or data-id to the DOM elements in updateUI first.
                // Assuming we fix updateUI to add data-id={id}
                const el = document.querySelector(`[data-id="${id}"]`);
                if (!el) return null;
                const r = el.getBoundingClientRect();
                return {
                    x: r.left + r.width / 2 - containerRect.left,
                    y: r.top + r.height / 2 - containerRect.top,
                    w: r.width, h: r.height,
                    left: r.left - containerRect.left,
                    right: r.right - containerRect.left
                };
            };

            currentMemoryState.arrows.forEach(arr => {
                const start = getBoxCenter(arr.from);
                const end = getBoxCenter(arr.to);

                if (start && end) {
                    // Draw Curve
                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    // Simple logic: right side of start -> left side of end if possible
                    // Or center to center

                    // Bezier
                    const d = `M ${start.right} ${start.y} C ${start.right + 20} ${start.y}, ${end.left - 20} ${end.y}, ${end.left} ${end.y}`;

                    path.setAttribute("d", d);
                    path.setAttribute("stroke", "#6366f1");
                    path.setAttribute("stroke-width", "2");
                    path.setAttribute("fill", "none");
                    path.setAttribute("marker-end", "url(#arrowhead)");
                    svg.appendChild(path);
                }
            });
        }
        const explanationText = document.getElementById('explanationText');
        const stackContent = document.getElementById('stackContent');
        const modulesContent = document.getElementById('modulesContent');

        // 1. INIT SIDEBAR
        const list = document.getElementById('exampleList');

        // "New Code" Button
        // REMOVE: "New Code" Button is now static in HTML
        // Clear list but keep the static button (first child)
        while (list.children.length > 1) {
            list.removeChild(list.lastChild);
        }

        codeExamples.forEach(ex => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-light btn-sm w-100 text-start mb-1'; // Material classes
            btn.innerText = ex.replace('.json', '').replace(/_/g, ' ');
            btn.onclick = (e) => loadExample(ex, e.currentTarget);
            list.appendChild(btn);
        });

        // 2. LOAD LOGIC
        async function loadExample(filename, btnElement = null) {
            try {
                // ... same loading logic ...
                const res = await fetch(`/api/code-examples/${filename}`);
                const data = await res.json();
                loadDataIntoEngine(data); // Refactored

                // Highlight
                // Highlight
                document.querySelectorAll('#exampleList button').forEach(b => {
                    b.classList.remove('bg-gradient-primary', 'text-white');
                    b.classList.add('btn-light');
                });
                if (btnElement) {
                    btnElement.classList.remove('btn-light');
                    btnElement.classList.add('bg-gradient-primary', 'text-white');
                }
            } catch (e) { console.error(e); alert("Failed to load example"); }
        }

        // Refactored engine loader
        function loadDataIntoEngine(data) {
            currentData = data;
            document.getElementById('progTitle').innerText = currentData.title || "Custom Code";
            renderCode(currentData.code);
            reset();
            document.getElementById('pasteModal').style.display = 'none'; // Close modal if open
        }

        async function submitCustomCode() {
            const code = document.getElementById('customCodeInput').value;
            if (!code.trim()) return;

            const btn = document.getElementById('submitCodeBtn');
            btn.disabled = true;
            btn.innerText = "Analyzing...";

            try {
                const res = await fetch('/api/code-explainer/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                loadDataIntoEngine(data);

                // Add temp button to sidebar
                const tempBtn = document.createElement('button');
                tempBtn.className = 'btn bg-gradient-primary btn-sm w-100 text-start mb-1 text-white';
                tempBtn.innerText = "✨ " + (data.title || "Custom");
                tempBtn.onclick = (e) => loadDataIntoEngine(data);
                list.appendChild(tempBtn); // Append at end

            } catch (e) {
                alert("Error generating visualization: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "Visualize";
            }
        }

        function renderCode(lines) {
            codeContainer.innerHTML = '';
            lines.forEach((txt, idx) => {
                const line = document.createElement('div');
                line.className = 'code-line';
                line.id = `line-${idx + 1}`;
                line.innerHTML = `<div class="line-num">${idx + 1}</div><div class="code-text">${escapeHtml(txt)}</div>`;
                codeContainer.appendChild(line);
            });
        }

        // 3. ENGINE LOGIC
        function reset() {
            currentStepIndex = -1;
            updateUI();
        }

        function step(dir) {
            if (!currentData) return;
            const newIndex = currentStepIndex + dir;
            if (newIndex < -1 || newIndex >= currentData.lines.length) return;

            currentStepIndex = newIndex;
            updateUI();
        }

        function updateUI() {
            // Buttons
            document.getElementById('btnPrev').disabled = currentStepIndex < 0;
            document.getElementById('btnNext').disabled = currentStepIndex >= currentData.lines.length - 1;
            document.getElementById('btnReset').disabled = false;

            // Clear State
            stackContent.innerHTML = '';
            modulesContent.innerHTML = '';
            document.querySelectorAll('.code-line').forEach(l => l.classList.remove('active'));

            if (currentStepIndex === -1) {
                explanationText.innerText = "Program ready. Click Next to start.";
                return;
            }

            // --- RECOMPUTE STATE FROM SCRATCH (ROBUST) ---
            // We simulate everything from Step 0 to currentStepIndex
            const memory = { stack: {}, modules: [], arrows: [] };

            for (let i = 0; i <= currentStepIndex; i++) {
                const stepData = currentData.lines[i];
                if (!stepData) continue; // Safety skip

                // Apply Actions
                if (stepData.actions && Array.isArray(stepData.actions)) {
                    stepData.actions.forEach(act => {
                        if (act.type === 'createBox') {
                            memory.stack[act.id] = { ...act };
                        } else if (act.type === 'updateBox') {
                            if (memory.stack[act.id]) {
                                if (act.value !== undefined) memory.stack[act.id].value = act.value;
                                if (act.fields) {
                                    // Merge fields logic
                                    memory.stack[act.id].fields = { ...memory.stack[act.id].fields, ...act.fields };
                                }
                                memory.stack[act.id].highlight = true;
                            }
                        } else if (act.type === 'updateArrayIndex') {
                            if (memory.stack[act.id] && memory.stack[act.id].isArray) {
                                memory.stack[act.id].values[act.index] = act.value;
                                memory.stack[act.id].highlight = true;
                            }
                        } else if (act.type === 'deleteBox') {
                            delete memory.stack[act.id];
                        } else if (act.type === 'createArray') {
                            memory.stack[act.id] = { ...act, isArray: true };
                        } else if (act.type === 'showModule') {
                            // Avoid duplicates for modules
                            if (!memory.modules.find(m => m.label === act.label)) {
                                memory.modules.push(act);
                            }
                        } else if (act.type === 'highlightBox') {
                            if (memory.stack[act.id]) memory.stack[act.id].highlight = true;
                        } else if (act.type === 'addArrow') {
                            memory.arrows.push(act);
                        }
                    });
                }
            }

            // Render Current Line Explanation
            const currentLineData = currentData.lines[currentStepIndex];
            explanationText.innerText = currentLineData.explanation || "";

            // Highlight Code
            const codeLineDiv = document.getElementById(`line-${currentLineData.line}`);
            if (codeLineDiv) {
                codeLineDiv.classList.add('active');
                codeLineDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // Render Memory
            memory.modules.forEach(mod => {
                const div = document.createElement('div');
                div.className = 'module-box';
                div.innerText = mod.label;
                modulesContent.appendChild(div);
            });

            // Render Memory Logic
            // stackContent and heapContent are global or need to be accessed from DOM if not
            const heapContent = document.getElementById('heapContent');
            stackContent.innerHTML = '';
            heapContent.innerHTML = '';

            // Render Modules
            modulesContent.innerHTML = '';
            memory.modules.forEach(mod => {
                const div = document.createElement('div');
                div.className = 'module-box';
                div.innerText = mod.label;
                modulesContent.appendChild(div);
            });

            // Render Variables (Stack vs Heap)
            Object.values(memory.stack).forEach(item => {
                const wrapper = document.createElement('div');
                wrapper.className = `mem-box ${item.highlight ? 'highlight' : ''}`;
                wrapper.setAttribute('data-id', item.id);

                // Content Generation
                if (item.isArray) {
                    let html = `<div class="label">${item.label} [Array]</div><div class="arr-container">`;
                    if (item.values) {
                        item.values.forEach(v => { html += `<div class="arr-cell">${v}</div>`; });
                    }
                    html += `</div>`;
                    wrapper.innerHTML = html;
                    wrapper.style.width = 'auto';
                } else if (item.fields) {
                    // Struct Render
                    let html = `<div class="label">${item.label}</div><div style="text-align:left; font-size:0.8rem; margin-top:5px; width:100%;">`;
                    Object.entries(item.fields).forEach(([k, v]) => {
                        let displayVal = `<span style="font-family:monospace; font-weight:bold;">${v}</span>`;

                        // Check if value is array string e.g. "[1, 2, ...]"
                        if (typeof v === 'string' && v.trim().startsWith('[') && v.trim().endsWith(']')) {
                            // Render Mini Array
                            const clean = v.replace(/[\[\]]/g, '');
                            const parts = clean.split(',').map(s => s.trim());
                            displayVal = `<div style="display:flex; gap:1px; margin-top:2px;">`;
                            parts.forEach(p => {
                                let content = p;
                                let style = "width:20px; height:20px; border:1px solid #ddd; display:flex; align-items:center; justify-content:center; font-size:0.7rem; background:#f9fafb;";

                                // Check for stale value (x)
                                if (p.startsWith('(') && p.endsWith(')')) {
                                    content = p.slice(1, -1);
                                    style += "color:#d1d5db; background:#f3f4f6;"; // Greyed out
                                }
                                displayVal += `<div style="${style}">${content === '_' ? '' : content}</div>`;
                            });
                            displayVal += `</div>`;
                        }

                        html += `<div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:4px 0;">
                                   <span style="color:#6b7280; margin-right:8px;">${k}:</span>
                                   ${displayVal}
                                 </div>`;
                    });
                    html += `</div>`;
                    wrapper.innerHTML = html;
                    wrapper.style.width = 'auto'; // allow expand
                    wrapper.style.minWidth = '140px';
                } else {
                    wrapper.innerHTML = `
                        <div class="label">${item.label}</div>
                        <div class="value">${item.value}</div>
                        ${item.address ? `<div class="addr">${item.address}</div>` : ''}
                    `;
                }

                // PLACEMENT
                if (item.segment === 'heap') {
                    wrapper.style.borderColor = '#fda4af';
                    heapContent.appendChild(wrapper);
                } else {
                    stackContent.appendChild(wrapper);
                }
            });

            // Handle Animations (GSAP)
            gsap.from('.mem-box.highlight', { scale: 1.1, border: '2px solid yellow', duration: 0.5 });

            // Allow DOM layout to settle before drawing arrows
            setTimeout(renderArrows, 50);
        }

        function renderArrows() {
            const container = document.querySelector('.memory-area');
            let svg = document.getElementById('arrow-layer');
            if (!svg) {
                svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.id = "arrow-layer";
                svg.style.position = 'absolute';
                svg.style.top = '0';
                svg.style.left = '0';
                svg.style.width = '100%';
                svg.style.height = '100%';
                svg.style.pointerEvents = 'none';
                svg.style.zIndex = '10';
                container.appendChild(svg);
            }
            svg.innerHTML = `
             <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                  <polygon points="0 0, 10 3.5, 0 7" fill="#6366f1" />
                </marker>
             </defs>
            `;

            // Simple Arrow State Reconstruction
            // We need to re-find arrows from currentData step by step if not stored
            // But wait, updateUI() already rebuilt 'memory.arrows'
            // We need access to 'memory' here. Let's make memory global-ish or stored
        }

        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        // Auto load first example if available
        if (codeExamples.length > 0) loadExample(codeExamples[0]);

    </script>
</body>

</html>