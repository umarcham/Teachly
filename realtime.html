<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/logos/learning_10051578.png">
  <link rel="icon" type="image/png" href="../assets/img/logos/learning_10051578.png">
  <title>
    Teachly by IBH
  </title>
  <!--     Fonts and icons     -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
  <!-- Nucleo Icons -->
  <link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <!-- Material Icons -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <!-- CSS Files -->
  <link id="pagestyle" href="../assets/css/material-dashboard.css?v=3.2.0" rel="stylesheet" />
</head>
<style>
  :root {
    --soft-shadow: 0 10px 30px rgba(2, 6, 23, .08);
    --soft-shadow-2: 0 20px 50px rgba(2, 6, 23, .10);
    --ring: #344767;
  }

  .shadow-soft {
    box-shadow: var(--soft-shadow);
    border-radius: 16px;
  }

  .stage-card {
    overflow: hidden;
  }

  .stage-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 18px;
  }

  .status-pill {
    padding: .3rem .6rem;
    border-radius: 999px;
    font-size: .7rem;
    letter-spacing: .6px;
    background: #5e6d82;
    color: #fff;
  }

  .stage-frame {
    position: relative;
    border-radius: 16px;
    margin: 0 16px 12px 16px;
    overflow: hidden;
    background:
      radial-gradient(1200px 300px at -10% -50%, #e9ecff 0, transparent 48%),
      radial-gradient(1200px 300px at 110% 150%, #e9ecff 0, transparent 48%),
      #0b0d12;
    aspect-ratio: 16/9;
    display: grid;
    place-items: center;
  }

  #dailyMount,
  #dailyMount iframe {
    width: 100% !important;
    height: 100% !important;
    border: 0;
  }

  .stage-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 16px 18px 16px;
  }

  .btn-glass {
    background: linear-gradient(180deg, #111315, #0e1013);
    color: #fff;
    border: 1px solid #1d2230;
    border-radius: 10px;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, .06), 0 8px 18px rgba(0, 0, 0, .25);
  }

  .btn-glass:hover {
    filter: brightness(1.06);
  }

  .btn-outline-soft {
    border: 1px solid #dfe5ef;
    background: #fff;
    color: #2a2e36;
    border-radius: 10px;
  }

  .btn-chip {
    border: 1px solid #e6eaf2;
    background: #f8f9fc;
    color: #2a2e36;
    border-radius: 999px;
    padding: .4rem .8rem;
  }

  .hint {
    color: #8b95a7;
  }

  .sticky-side {
    position: sticky;
    top: 18px;
  }

  .chip-muted {
    border: 1px solid #e6eaf2;
    border-radius: 999px;
    padding: .25rem .6rem;
    background: #fff;
    font-size: .78rem;
    color: #495057;
  }

  .search-bar {
    position: relative;
    width: 260px;
  }

  .search-bar i {
    position: absolute;
    left: .5rem;
    top: 50%;
    transform: translateY(-50%);
    color: #96a0b3;
  }

  .search-bar .form-control {
    padding-left: 2rem;
  }

  /* Replica cards */
  .replica-card {
    border: 1px solid #e9edf5;
    border-radius: 14px;
    background: #fff;
    overflow: hidden;
    cursor: pointer;
    transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease;
    position: relative;
  }

  .replica-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--soft-shadow-2);
  }

  .replica-card.selected {
    border-color: var(--ring);
    box-shadow: 0 0 0 2px #3447671a, var(--soft-shadow-2);
  }

  .replica-thumb {
    width: 100%;
    aspect-ratio: 4/5;
    object-fit: cover;
    background: #f3f5fb;
    display: block;
    transition: transform .25s ease;
  }

  .replica-card:hover .replica-thumb {
    transform: scale(1.03);
  }

  .replica-meta {
    padding: .7rem .8rem;
  }

  .replica-name {
    font-weight: 600;
    color: #222;
    font-size: .95rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .replica-id {
    color: #8b95a7;
    font-size: .72rem;
  }

  .replica-card.selected::after {
    content: 'done';
    font-family: 'Material Symbols Rounded';
    font-size: 18px;
    position: absolute;
    top: .6rem;
    right: .6rem;
    width: 28px;
    height: 28px;
    border-radius: 999px;
    background: #1a73e8;
    color: #fff;
    display: grid;
    place-items: center;
    box-shadow: 0 6px 18px rgba(26, 115, 232, .35);
  }

  .form-control-lg {
    padding: .85rem 1rem;
    border-radius: 12px;
  }

  /* Mini selected-replica preview */
  .replica-mini {
    display: flex;
    align-items: center;
    gap: .65rem;
    min-width: 0;
    padding: .4rem .55rem;
    border: 1px solid #e6eaf2;
    border-radius: 12px;
    background: #fff;
    box-shadow: 0 6px 18px rgba(2, 6, 23, .06);
  }

  .replica-mini img {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    object-fit: cover;
    background: #f3f5fb;
  }

  .replica-mini .meta {
    min-width: 0;
  }

  .replica-mini .name {
    font-weight: 600;
    color: #222;
    font-size: .9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 180px;
  }

  .replica-mini .sub {
    font-size: .72rem;
    color: #8b95a7;
    line-height: 1;
  }

  /* Softer outline button */
  .btn-outline-soft {
    border: 1px solid #dfe5ef;
    background: #fff;
    color: #2a2e36;
    border-radius: 12px;
    padding: .6rem 1rem;
  }

  .chip-media {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    overflow: hidden;
    background: #f3f5fb;
  }

  .chip-media>video,
  .chip-media>img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
</style>




<body class="g-sidenav-show  bg-gray-100">
  <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-radius-lg fixed-start ms-2  bg-white my-2"
    id="sidenav-main">
    <div class="sidenav-header">
      <i class="fas fa-times p-3 cursor-pointer text-dark opacity-5 position-absolute end-0 top-0 d-none d-xl-none"
        aria-hidden="true" id="iconSidenav"></i>
      <a class="navbar-brand px-4 py-3 m-0" href="#" target="_blank">
        <img src="../assets/img/logos/learning_10051578.png" class="navbar-brand-img" width="36" height="36"
          alt="main_logo">
        <span class="ms-1 text-sm text-dark">Teachly</span>
      </a>
    </div>
    <hr class="horizontal dark mt-0 mb-2">
    <div class="collapse navbar-collapse  w-auto " id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link text-dark" href="../pages/dashboard.html">
            <i class="material-symbols-rounded opacity-5">dashboard</i>
            <span class="nav-link-text ms-1">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active bg-gradient-dark text-white" href="#">
            <i class="material-symbols-rounded opacity-5">record_voice_over</i>

            <span class="nav-link-text ms-1">AI Agents</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="../pages/billing.html">
            <i class="material-symbols-rounded opacity-5">receipt_long</i>
            <span class="nav-link-text ms-1">Billing</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="https://nelda-grippelike-kaylee.ngrok-free.dev/">
            <i class="material-symbols-rounded opacity-5">co_present</i>

            <span class="nav-link-text ms-1">Lecture Genrator</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="/whiteboard">
            <i class="material-symbols-rounded opacity-5 me-2">edit_note</i>
            <span class="nav-link-text">Whiteboard Engine</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="#">
            <i class="material-symbols-rounded opacity-5">notifications</i>
            <span class="nav-link-text ms-1">Notifications</span>
          </a>
        </li>
        <li class="nav-item mt-3">
          <h6 class="ps-4 ms-2 text-uppercase text-xs text-dark font-weight-bolder opacity-5">Account pages</h6>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="#">
            <i class="material-symbols-rounded opacity-5">person</i>
            <span class="nav-link-text ms-1">Profile</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="../pages/sign-in.html">
            <i class="material-symbols-rounded opacity-5">login</i>
            <span class="nav-link-text ms-1">Sign In</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="../pages/sign-up.html">
            <i class="material-symbols-rounded opacity-5">assignment</i>
            <span class="nav-link-text ms-1">Sign Up</span>
          </a>
        </li>
      </ul>
    </div>
    <div class="sidenav-footer position-absolute w-100 bottom-0 ">
      <div class="mx-3">
        <a class="btn bg-gradient-dark w-100" href="#" type="button">Upgrade to pro</a>
      </div>
    </div>
  </aside>
  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg ">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-3 shadow-none border-radius-xl" id="navbarBlur"
      data-scroll="true">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Pages</a></li>
            <li class="breadcrumb-item text-sm text-dark active" aria-current="page">Live Interaction</li>
          </ol>
        </nav>
        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">
            <div class="input-group input-group-outline">
              <label class="form-label">Type here...</label>
              <input type="text" class="form-control">
            </div>
          </div>
          <ul class="navbar-nav d-flex align-items-center  justify-content-end">

            <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0" id="iconNavbarSidenav">
                <div class="sidenav-toggler-inner">
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                </div>
              </a>
            </li>
            <li class="nav-item px-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0">
                <i class="material-symbols-rounded fixed-plugin-button-nav">settings</i>
              </a>
            </li>
            <li class="nav-item dropdown pe-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0" id="dropdownMenuButton" data-bs-toggle="dropdown"
                aria-expanded="false">
                <i class="material-symbols-rounded">notifications</i>
              </a>
              <ul class="dropdown-menu  dropdown-menu-end  px-2 py-3 me-sm-n4" aria-labelledby="dropdownMenuButton">
                <li class="mb-2">
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="my-auto">
                        <img src="../assets/img/team-2.jpg" class="avatar avatar-sm  me-3 ">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="text-sm font-weight-normal mb-1">
                          <span class="font-weight-bold">New message</span> from Laur
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          <i class="fa fa-clock me-1"></i>
                          13 minutes ago
                        </p>
                      </div>
                    </div>
                  </a>
                </li>
                <li class="mb-2">
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="my-auto">
                        <img src="../assets/img/small-logos/logo-spotify.svg"
                          class="avatar avatar-sm bg-gradient-dark  me-3 ">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="text-sm font-weight-normal mb-1">
                          <span class="font-weight-bold">New album</span> by Travis Scott
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          <i class="fa fa-clock me-1"></i>
                          1 day
                        </p>
                      </div>
                    </div>
                  </a>
                </li>
                <li>
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="avatar avatar-sm bg-gradient-secondary  me-3  my-auto">
                        <svg width="12px" height="12px" viewBox="0 0 43 36" version="1.1"
                          xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                          <title>credit-card</title>
                          <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                            <g transform="translate(-2169.000000, -745.000000)" fill="#FFFFFF" fill-rule="nonzero">
                              <g transform="translate(1716.000000, 291.000000)">
                                <g transform="translate(453.000000, 454.000000)">
                                  <path class="color-background"
                                    d="M43,10.7482083 L43,3.58333333 C43,1.60354167 41.3964583,0 39.4166667,0 L3.58333333,0 C1.60354167,0 0,1.60354167 0,3.58333333 L0,10.7482083 L43,10.7482083 Z"
                                    opacity="0.593633743"></path>
                                  <path class="color-background"
                                    d="M0,16.125 L0,32.25 C0,34.2297917 1.60354167,35.8333333 3.58333333,35.8333333 L39.4166667,35.8333333 C41.3964583,35.8333333 43,34.2297917 43,32.25 L43,16.125 L0,16.125 Z M19.7083333,26.875 L7.16666667,26.875 L7.16666667,23.2916667 L19.7083333,23.2916667 L19.7083333,26.875 Z M35.8333333,26.875 L28.6666667,26.875 L28.6666667,23.2916667 L35.8333333,23.2916667 L35.8333333,26.875 Z">
                                  </path>
                                </g>
                              </g>
                            </g>
                          </g>
                        </svg>
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="text-sm font-weight-normal mb-1">
                          Payment successfully completed
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          <i class="fa fa-clock me-1"></i>
                          2 days
                        </p>
                      </div>
                    </div>
                  </a>
                </li>
              </ul>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a href="../pages/sign-in.html" class="nav-link text-body font-weight-bold px-0">
                <i class="material-symbols-rounded">account_circle</i>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid py-4">
      <div class="row g-4">
        <!-- STAGE -->
        <div class="col-12 col-xxl-8">
          <div class="stage-card card border-0 shadow-soft">
            <div class="stage-header">
              <h6 class="mb-0">Live Agent</h6>
              <span id="agentStatus" class="status-pill">IDLE</span>
            </div>

            <div class="stage-frame">
              <div id="dailyMount"></div>
            </div>

            <div class="stage-controls">
              <div class="btn-group-main">
                <button id="startBtn" class="btn btn-glass btn-dark px-4">
                  <i class="material-symbols-rounded me-1">play_arrow</i> Start Session
                </button>
                <button id="endBtn" class="btn btn-outline-soft" disabled>
                  <i class="material-symbols-rounded me-1">stop</i> End
                </button>
              </div>

              <div class="btn-group-mini">
                <button id="micBtn" class="btn btn-chip" disabled>
                  <i class="material-symbols-rounded me-1">mic</i> Mic
                </button>
                <button id="camBtn" class="btn btn-chip" disabled>
                  <i class="material-symbols-rounded me-1">videocam</i> Cam
                </button>
              </div>

              <small class="hint ms-auto">Allow camera & microphone when prompted.</small>
            </div>
          </div>
        </div>

        <!-- SIDEBAR -->
        <!-- SIDEBAR -->
        <div class="col-12 col-xxl-4">
          <div class="card border-0 shadow-soft sticky-side">
            <div class="card-body">
              <h6 class="mb-3">Session Setup</h6>

              <label class="form-label text-dark mb-1">Topic (optional)</label>
              <input id="topicField" type="text" class="form-control form-control-lg mb-3"
                placeholder="Newton’s Laws, Photosynthesis, Fractions…" />

              <label class="form-label text-dark mb-1">Session name (optional)</label>
              <input id="sessionName" type="text" class="form-control form-control-lg" placeholder="My Live Lesson" />

              <div class="d-flex align-items-center justify-content-between mt-4">
                <!-- Selected replica preview (hidden until chosen) -->
                <!-- Replace the old selected replica chip markup with this -->
                <div id="selectedReplicaWrap" class="d-none d-flex align-items-center gap-3">
                  <div id="selectedReplicaMedia" class="chip-media"></div>
                  <div class="d-flex flex-column">
                    <div id="selectedReplicaName" class="fw-semibold text-dark">—</div>
                    <div class="text-xs text-secondary">Selected replica</div>
                  </div>
                </div>


                <button id="startBtnTop" class="btn btn-outline-soft">
                  <i class="material-symbols-rounded me-1">play_circle</i> Start
                </button>
              </div>
            </div>
          </div>
        </div>


        <!-- REPLICAS -->
        <div class="col-12">
          <div class="card border-0 shadow-soft">
            <div class="card-header d-flex align-items-center justify-content-between">
              <h6 class="mb-0">Choose Replica</h6>
              <div class="search-bar">
                <i class="material-symbols-rounded">search</i>
                <input id="replicaSearch" type="text" class="form-control form-control-sm"
                  placeholder="Search replicas…" />
              </div>
            </div>
            <div class="card-body">
              <div id="replicaGrid" class="row g-3"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- hidden -->
      <input id="replicaId" type="hidden" />
      <input id="personaId" type="hidden" />
    </div>


    </aside>
    <!-- Daily JS (WebRTC client) -->
    <script src="https://unpkg.com/@daily-co/daily-js"></script>

    <script>
      // Elements
      const startBtn = document.getElementById('startBtn');
      const startBtnTop = document.getElementById('startBtnTop');
      const endBtn = document.getElementById('endBtn');
      const micBtn = document.getElementById('micBtn');
      const camBtn = document.getElementById('camBtn');
      const agentStatus = document.getElementById('agentStatus');
      const transcriptBox = document.getElementById('transcriptBox');
      const replicaIdEl = document.getElementById('replicaId');
      const personaIdEl = document.getElementById('personaId');
      const sessionNameEl = document.getElementById('sessionName');

      const dailyMount = document.getElementById('dailyMount');

      let callFrame = null;
      let inCall = false;

      function setStatus(txt, colorClass = 'bg-gradient-secondary') {
        agentStatus.className = 'badge ' + colorClass;
        agentStatus.textContent = txt;
      }

      function appendCaption(who, text) {
        const p = document.createElement('div');
        p.innerHTML = `<span class="text-dark fw-semibold">${who}:</span> ${text}`;
        transcriptBox.appendChild(p);
        transcriptBox.scrollTop = transcriptBox.scrollHeight;
      }

      async function createConversation(replicaId, personaId, name) {
        const body = { replica_id: replicaId };
        if (personaId) body.persona_id = personaId;   // ← only send if non-empty
        if (name) body.conversation_name = name;

        const res = await fetch('/api/tavus/conversations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const text = await res.text();
        if (!res.ok) {
          console.error('Backend error:', text);
          alert('Tavus error:\n' + text);
          throw new Error(`Create conversation failed: ${res.status}`);
        }
        return JSON.parse(text);
      }


      async function startSession() {
        const replicaId = (document.getElementById('replicaId')?.value || '').trim();
        const personaId = (document.getElementById('personaId')?.value || '').trim();
        const name = (document.getElementById('sessionName')?.value || '').trim();

        if (!replicaId) {
          alert('Please select a Replica and a Persona.');
          return;
        }
        if (inCall) return;

        if (!window.DailyIframe) {
          console.error('Daily JS not loaded');
          setStatus('error', 'bg-gradient-danger');
          return;
        }

        setStatus('starting...', 'bg-gradient-info');

        // 1) Create Tavus conversation via your Flask proxy
        let convo;
        try {
          convo = await createConversation(replicaId, personaId, name);
        } catch (e) {
          console.error(e);
          setStatus('error', 'bg-gradient-danger');
          return;
        }

        const url = convo.conversation_url || convo.url || convo.room_url;
        if (!url) {
          console.error('No conversation_url in response', convo);
          setStatus('error', 'bg-gradient-danger');
          return;
        }

        // If a previous frame exists, cleanup
        if (callFrame) {
          try { await callFrame.leave(); } catch (_) { }
          try { callFrame.destroy(); } catch (_) { }
          callFrame = null;
          document.getElementById('dailyMount').innerHTML = '';
        }

        // 2) Create Daily iframe
        callFrame = window.DailyIframe.createFrame(document.getElementById('dailyMount'), {
          url,
          showLeaveButton: false,
          showFullscreenButton: true,
          iframeStyle: {
            border: '0',
            width: '100%',
            height: '100%',
            borderRadius: '0px',
            backgroundColor: 'black'
          }
        });

        // 3) Join the session
        try {
          await callFrame.join();
          inCall = true;
          setStatus('connected', 'bg-gradient-success');

          // toggle controls safely
          if (window.startBtn) startBtn.disabled = true;
          if (window.startBtnTop) startBtnTop.disabled = true;
          if (window.endBtn) endBtn.disabled = false;
          if (window.micBtn) micBtn.disabled = false;
          if (window.camBtn) camBtn.disabled = false;

          if (window.transcriptBox) transcriptBox.innerHTML = '';
        } catch (err) {
          console.error('Join failed', err);
          setStatus('error', 'bg-gradient-danger');
          return;
        }

        // 4) Events
        callFrame.on('left-meeting', () => {
          inCall = false;
          setStatus('ended', 'bg-gradient-secondary');
          if (window.startBtn) startBtn.disabled = false;
          if (window.startBtnTop) startBtnTop.disabled = false;
          if (window.endBtn) endBtn.disabled = true;
          if (window.micBtn) micBtn.disabled = true;
          if (window.camBtn) camBtn.disabled = true;
          document.getElementById('dailyMount').innerHTML = '';
        });

        callFrame.on('app-message', (e) => {
          try {
            const msg = typeof e?.data === 'string' ? JSON.parse(e.data) : e.data;
            if (msg?.type === 'transcript' && msg.text) {
              appendCaption('Agent', msg.text);
            }
          } catch (_) { }
        });

        // 5) Optional: auto-send topic prompt
        const topic = (document.getElementById('topicField')?.value || '').trim();
        const firstMsg = topic
          ? `Please teach me about ${topic}.`
          : 'Hello! You are a teaching assistant. Start by asking what I want to learn.';
        try {
          callFrame.sendAppMessage({ type: 'input_text', text: firstMsg });
        } catch (_) {
          // ignore if app-message channel is not enabled
        }
      }


      async function endSession() {
        if (!callFrame) return;
        try { await callFrame.leave(); } catch (_) { }
        callFrame.destroy();
        callFrame = null;
        inCall = false;
        setStatus('idle', 'bg-gradient-secondary');
        startBtn.disabled = false;
        startBtnTop.disabled = false;
        endBtn.disabled = true;
        micBtn.disabled = true;
        camBtn.disabled = true;
        dailyMount.innerHTML = '';
      }

      // Mic / Cam toggles use Daily's setLocalAudio/Video()
      micBtn.addEventListener('click', async () => {
        if (!callFrame) return;
        const state = callFrame.localAudio();
        await callFrame.setLocalAudio(!state);
        micBtn.classList.toggle('btn-outline-dark', !callFrame.localAudio());
        micBtn.classList.toggle('btn-light', callFrame.localAudio());
      });

      camBtn.addEventListener('click', async () => {
        if (!callFrame) return;
        const state = callFrame.localVideo();
        await callFrame.setLocalVideo(!state);
        camBtn.classList.toggle('btn-outline-dark', !callFrame.localVideo());
        camBtn.classList.toggle('btn-light', callFrame.localVideo());
      });

      startBtn.addEventListener('click', startSession);
      startBtnTop.addEventListener('click', startSession);
      endBtn.addEventListener('click', endSession);

      // Optional: preload IDs for dev
      // replicaIdEl.value = "rep_...";
      // personaIdEl.value = "per_...";
    </script>

    <script>
      const replicaGrid = document.getElementById('replicaGrid');
      const replicaSearch = document.getElementById('replicaSearch');
      const personaRow = document.getElementById('personaRow');
      const hiddenReplica = document.getElementById('replicaId');
      const hiddenPersona = document.getElementById('personaId');

      let replicas = [];
      let filtered = [];
      let personas = [];



      function renderReplicas(list) {
        replicaGrid.innerHTML = '';
        if (!list.length) {
          replicaGrid.innerHTML = '<div class="text-secondary px-2">No replicas found.</div>';
          return;
        }

        list.forEach(replica => {
          const col = document.createElement('div');
          col.className = 'col-6 col-md-4 col-lg-3';

          // ✅ Build media element
          let mediaHTML = '';
          if (replica.thumbVideo) {
            mediaHTML = `
        <video class="replica-thumb"
               src="${replica.thumbVideo}"
               muted autoplay playsinline loop preload="metadata"></video>
      `;
          } else {
            mediaHTML = `
        <img class="replica-thumb"
             src="/assets/img/placeholders/teacher_female.jpg"
             alt="${replica.name}" />
      `;
          }

          col.innerHTML = `
      <div class="replica-card" data-id="${replica.id}">
        ${mediaHTML}
        <div class="p-2">
          <div class="text-sm fw-semibold text-dark text-truncate" title="${replica.name}">
            ${replica.name || 'Unnamed Replica'}
          </div>
          <div class="text-xs text-secondary">${replica.id}</div>
        </div>
      </div>
    `;

          // Click to select
          col.querySelector('.replica-card').addEventListener('click', () => {
            replicaGrid.querySelectorAll('.replica-card').forEach(c => c.classList.remove('selected'));
            col.querySelector('.replica-card').classList.add('selected');
            hiddenReplica.value = replica.id;

            // Update the small summary chip
            showSelectedReplica({
              name: replica.name,
              thumb: replica.thumb,
              thumb: replica.thumbVideo || '/assets/img/placeholders/teacher_female.jpg'
            });
          });

          replicaGrid.appendChild(col);
        });
      }



      const FALLBACK_AVATAR =
        'data:image/svg+xml;utf8,' + encodeURIComponent(`
    <svg xmlns="http://www.w3.org/2000/svg" width="200" height="200">
      <rect width="100%" height="100%" fill="#EEF2FF"/>
      <circle cx="100" cy="85" r="52" fill="#D9E2FF"/>
      <rect x="40" y="130" width="120" height="50" rx="20" fill="#E7ECFF"/>
    </svg>
  `);

      // ✅ call this whenever a card is selected OR after preload-select
      function showSelectedReplica(replica) {
        const wrap = document.getElementById('selectedReplicaWrap');
        const media = document.getElementById('selectedReplicaMedia');
        const name = document.getElementById('selectedReplicaName');

        if (!replica) {
          wrap.classList.add('d-none');
          return;
        }

        media.innerHTML = ''; // clear

        if (replica.thumbVideo) {
          const v = document.createElement('video');
          v.src = replica.thumbVideo;
          v.muted = true;
          v.playsInline = true;
          v.autoplay = true;
          v.loop = true;
          v.addEventListener('error', () => {
            media.innerHTML = `<img src="${FALLBACK_AVATAR}" alt="">`;
          });
          media.appendChild(v);

          // Some browsers require explicit play()
          const tryPlay = v.play?.();
          if (tryPlay && typeof tryPlay.catch === 'function') {
            tryPlay.catch(() => {
              // If autoplay is blocked, fallback to a static image
              media.innerHTML = `<img src="${FALLBACK_AVATAR}" alt="">`;
            });
          }
        } else {
          const img = document.createElement('img');
          img.src = replica.thumb || FALLBACK_AVATAR;
          img.alt = replica.name || 'Replica';
          img.onerror = () => { img.src = FALLBACK_AVATAR; };
          media.appendChild(img);
        }

        name.textContent = replica.name || 'Selected replica';
        wrap.classList.remove('d-none');
      }





      function renderPersonas(list) {
        personaRow.innerHTML = '';
        list.forEach(p => {
          const chip = document.createElement('div');
          chip.className = 'persona-chip';
          chip.textContent = p.name;
          chip.dataset.id = p.id;
          chip.addEventListener('click', () => {
            personaRow.querySelectorAll('.persona-chip').forEach(c => c.classList.remove('selected'));
            chip.classList.add('selected');
            hiddenPersona.value = p.id;
          });
          personaRow.appendChild(chip);
        });
      }

      async function loadReplicas() {
        const res = await fetch('/api/tavus/replicas');
        const data = await res.json();
        replicas = data.items || [];
        filtered = replicas.slice();
        renderReplicas(filtered);
      }

      async function loadPersonas() {
        const res = await fetch('/api/tavus/personas');
        const data = await res.json();
        personas = data.items || [];
        renderPersonas(personas);
      }

      replicaSearch.addEventListener('input', () => {
        const q = replicaSearch.value.toLowerCase().trim();
        filtered = replicas.filter(r =>
          r.name.toLowerCase().includes(q) ||
          r.id.toLowerCase().includes(q)
        );
        renderReplicas(filtered);
      });

      // Kick off on page load
      (async () => {
        await Promise.all([loadReplicas(), loadPersonas()]);
        // Optional: preselect first items
        const firstCard = replicaGrid.querySelector('.replica-card');
        if (firstCard) {
          firstCard.classList.add('selected');
          hiddenReplica.value = firstCard.dataset.id;
        }
        const firstPersona = personaRow.querySelector('.persona-chip');
        if (firstPersona) {
          firstPersona.classList.add('selected');
          hiddenPersona.value = personas[0]?.id || '';
        }
      })();
    </script>


</body>

</html>